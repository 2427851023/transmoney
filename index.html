<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>？？のS？？攒钱计划</title>
    <style>
        :root {
            --primary-blue: #6ecff6;
            --light-pink: #ffb6c1;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 极客时间1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-image: url('请输入您自己的图源地址');/* 当然，您也可以使用我们的随机图源apihttps://www.cwcu.cn/datas/pics/background */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
        }
        
        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.6);
            z-index: -1;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a4a4a;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-pink));
            border-radius: 2px;
            animation: underlinePulse 2s infinite;
        }
        
        @keyframes underlinePulse {
            0% { width: 100px; }
            50% { width: 150px; }
            100% { width: 100px; }
        }
        
        .amount-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .amount-box {
            flex: 1;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .amount-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        
        .amount-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 65%, rgba(255, 255, 255, 0.3) 100%);
            z-index: 1;
        }
        
        .target-box {
            background: linear-gradient(135deg, var(--primary-blue), #8bd8f8);
            color: white;
        }
        
        .saved-box {
            background: linear-gradient(135deg, var(--light-pink), #ffc0cb);
            color: white;
        }
        
        .amount-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        .amount-value {
            font-size: 2.2rem;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }
        
        .currency {
            font-size: 1.5rem;
            margin-right: 5px;
        }
        
        .progress-container {
            width: 100%;
            margin-top: 20px;
            position: relative;
        }
        
        .progress-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #555;
            animation: fadeIn 1s ease;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px var(--shadow);
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 15px;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-pink));
            transition: width 1.5s ease-out, background-color 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            animation: colorShift 5s infinite alternate;
        }
        
        @keyframes colorShift {
            0% { background: linear-gradient(90deg, var(--primary-blue), var(--light-pink)); }
            100% { background: linear-gradient(90deg, #5fb8e6, #ff9eb5); }
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .character {
            position: absolute;
            bottom: -20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .motivation-text {
            text-align: center;
            margin-top: 40px;
            font-size: 1.1rem;
            color: #666;
            font-style: italic;
            animation: fadeIn 1.5s ease;
        }
        
        .edit-btn {
            display: block;
            margin: 30px auto 0;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-pink));
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px var(--shadow);
            transition: all 0.3s ease;
        }
        
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba极客时间(0, 0, 0, 0.15);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalSlide 极客时间0.3s ease;
        }
        
        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(110, 207, 246, 0.3);
        }
        
        .save-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-pink));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .error-message {
            color: #ff4d4d;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .amount-container {
                flex-direction: column;
            }
            
            .amount-box {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .character {
                width: 80px;
                height: 80px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>？？の？？攒钱计划</h1>
        
        <div class="amount-container">
            <div class="amount-box target-box">
                <div class="amount-title">目标</div>
                <div class="amount-value"><span class="currency">¥</span><span id="target-amount">0.00</span></div>
            </div>
            
            <div class="amount-box saved-box">
                <div class="amount-title">已攒金额</div>
                <div class="amount-value"><span class="currency">¥</span><span id="saved-amount">0.00</span></div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-title">进度</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
            </div>
        </div>
        
        <div class="character"></div>
        
        <div class="motivation-text" id="motivation-text">
            请设置您的攒钱目标金额
        </div>
        
        <button class="edit-btn" id="edit-btn">修改金额</button>
    </div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2>修改金额</h2>
            <div class="form-group">
                <label for="new-target">新的攒钱目标</label>
                <input type="number" id="new-target" placeholder="输入目标金额" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="new-saved">新的已攒金额</label>
                <input type="number" id="new-saved" placeholder="输入已攒金额" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="输入密码">
                <div class="error-message" id="password-error">密码错误！</div>
            </div>
            <button class="save-btn" id="save-btn">保存</button>
        </div>
    </div>
    
    <script>
        // 从服务器获取数据
        async function loadData() {
            try {
                console.log('正在加载数据...');
                const response = await fetch('api.php?action=get');
                
                if(!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('获取到的数据:', result);
                
                if(result.success) {
                    updateDisplay(result.data.targetAmount, result.data.savedAmount);
                } else {
                    console.error('加载数据失败:', result.message);
                    updateDisplay(0, 0);
                }
            } catch (error) {
                console.error('获取数据时出错:', error);
                updateDisplay(0, 0);
            }
        }
        
        // 保存数据到服务器
        async function saveData(target, saved, password) {
            try {
                console.log('正在保存数据...', {target, saved});
                const response = await fetch('api.php?action=save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        targetAmount: target,
                        savedAmount: saved,
                        password: password
                    })
                });
                
                const result = await response.json();
                console.log('保存结果:', result);
                return result;
            } catch (error) {
                console.error('保存数据时出错:', error);
                return {success: false, message: '网络错误'};
            }
        }
        
        // 更新显示
        function updateDisplay(target, saved) {
            // 确保值是数字
            target = parseFloat(target) || 0;
            saved = parseFloat(saved) || 0;
            
            console.log(`更新显示 - 目标: ${target}, 已存: ${saved}`);
            
            // 计算进度百分比
            let percentage = 0;
            if (target > 0) {
                percentage = (saved / target) * 100;
            }
            percentage = Math.min(100, Math.max(0, percentage)); // 限制在0-100之间
            const roundedPercentage = Math.round(percentage);
            
            console.log(`计算出的进度: ${percentage}%, 四舍五入: ${roundedPercentage}%`);
            
            // 更新进度条
            const progressFill = document.getElementById('progress-fill');
            if(progressFill) {
                progressFill.style.width = `${percentage}%`;
                progressFill.textContent = `${roundedPercentage}%`;
                console.log('进度条已更新');
            } else {
                console.error('找不到进度条元素');
            }
            
            // 格式化金额显示
            const formatCurrency = amount => {
                return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            };
            
            const targetEl = document.getElementById('target-amount');
            const savedEl = document.getElementById('saved-amount');
            
            if(targetEl) {
                targetEl.textContent = formatCurrency(target);
                console.log('目标金额已更新:', targetEl.textContent);
            }
            if(savedEl) {
                savedEl.textContent = formatCurrency(saved);
                console.log('已存金额已更新:', savedEl.textContent);
            }
            
            // 更新激励文本
            updateMotivationText(target, saved, roundedPercentage);
        }
        
        // 更新激励文本
        function updateMotivationText(target, saved, percentage) {
            const textElement = document.getElementById('motivation-text');
            if(!textElement) {
                console.error('找不到激励文本元素');
                return;
            }
            
            let text = "";
            
            if (target <= 0) {
                text = "请设置您的攒钱目标金额";
            } else if (percentage >= 100) {
                text = "恭喜！！重生之日即将到来~";
                createConfetti();
            } else if (percentage >= 80) {
                text = "80%了！！什么时候去预约手术呢？";
            } else if (percentage >= 50) {
                text = "50%！！小陌漓加油加油！";
            } else if (percentage >= 20) {
                text = "良好的开始是成功的一半！";
            } else {
                text = "快滚去工作！你还想不想SRS了？！";
            }
            
            textElement.textContent = text;
            console.log('激励文本已更新:', text);
        }
        
        // 创建庆祝彩花效果
        function createConfetti() {
            console.log('创建彩花效果');
            const colors = ['#6ecff6', '#ffb6c1', '#ffdf46', '#a8e6cf', '#dcedc1'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                const animation = confetti.animate([
                    { transform: `translateY(0) rotate(0)`, opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 2000,
                    easing: 'cubic-bezier(0.1, 0.8, 0.3, 1)',
                    delay: Math.random() * 2000
                });
                
                animation.onfinish = () => confetti.remove();
            }
        }
        
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM已加载完成');
            
            // 检查元素是否存在
            console.log('进度条元素:', document.getElementById('progress-fill'));
            console.log('目标金额元素:', document.getElementById('target-amount'));
            console.log('已存金额元素:', document.getElementById('saved-amount'));
            console.log('激励文本元素:', document.getElementById('motivation-text'));
            
            loadData();
            
            // 打开模态框
            document.getElementById('edit-btn').addEventListener('click', () => {
                console.log('点击了修改金额按钮');
                document.getElementById('modal').style.display = 'flex';
                document.getElementById('password-error').style.display = 'none';
                
                // 获取当前值填充表单
                const target = parseFloat(document.getElementById('target-amount').textContent.replace(/,/g, '')) || 0;
                const saved = parseFloat(document.getElementById('saved-amount').textContent.replace(/,/g, '')) || 0;
                
                document.getElementById('new-target').value = target;
                document.getElementById('new-saved').value = saved;
            });
            
            // 关闭模态框
            document.getElementById('close-modal').addEventListener('click', () => {
                console.log('点击了关闭按钮');
                document.getElementById('modal').style.display = 'none';
            });
            
            // 保存数据
            document.getElementById('save-btn').addEventListener('click', async () => {
                console.log('点击了保存按钮');
                const password = document.getElementById('password').value;
                
                // 验证密码
                if (!password) {
                    console.log('密码为空');
                    document.getElementById('password-error').style.display = 'block';
                    return;
                }
                
                const newTarget = parseFloat(document.getElementById('new-target').value) || 0;
                const newSaved = parseFloat(document.getElementById('new-saved').value) || 0;
                
                if (newTarget < 0 || newSaved < 0) {
                    console.log('金额为负数');
                    alert('金额不能为负数！');
                    return;
                }
                
                console.log(`尝试保存: 目标=${newTarget}, 已存=${newSaved}`);
                
                // 保存数据
                const result = await saveData(newTarget, newSaved, password);
                
                if (result.success) {
                    console.log('保存成功');
                    updateDisplay(newTarget, newSaved);
                    document.getElementById('modal').style.display = 'none';
                } else {
                    console.log('保存失败:', result.message);
                    document.getElementById('password-error').style.display = 'block';
                    document.getElementById('password-error').textContent = result.message || '保存失败';
                }
            });
            
            // 点击模态框外部关闭
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) {
                    console.log('点击模态框外部');
                    document.getElementById('modal').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>